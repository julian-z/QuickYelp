<!DOCTYPE html>
<html>
<head>
    <title>QuickYelp - Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='outputs.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="react-chat"></div>

    <script>
        // Event listener for cleaning up tempfiles/Redis
        window.addEventListener("beforeunload", async () => {
            try {
                const response = await fetch('/cleanup', {
                    method: 'POST'
                });
        
                if (!response.ok) {
                    console.error("CLEANUP REQUEST FAILED FROM JS");
                }
            } catch (error) {
                console.error("CLEANUP REQUEST ERROR FROM JS:", error);
            }
        });
    </script>

    <script type="text/babel">
        // Inherit React component
        class ChatApp extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    chatHistory: ["BOT👋 Welcome to QuickYelp! I have scanned through the business you provided. Feel free to ask questions about it!", "BOT{{ initial_response }}"],
                    query: "",
                    waiting: false,
                    about: false,
                };
                this.chatLogRef = React.createRef();
            }


            // Toggle the About section (TO-DO)
            toggleAboutSection = () => {
                this.setState((prevState) => ({
                    about: !prevState.about,
                }));
            };
    

            // Handle asynchronous calls to Flask
            handleSubmit = async (event) => {
                event.preventDefault();

                const formData = new FormData(event.target);
                const userQuery = formData.get("query");

                try {
                    // Display the user's query in the chat history
                    this.setState((prevState) => ({
                        chatHistory: [...prevState.chatHistory, "USR" + userQuery, "BOTLOADING"],
                        query: "",
                        waiting: true,
                    }), () => {
                            // Scroll the chat log container to the bottom
                            this.chatLogRef.current.scrollTop = this.chatLogRef.current.scrollHeight;
                    });

                    const response = await fetch("/", {
                        method: "POST",
                        body: formData,
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const sanitizedUserQuery = data.sanitized_user_query;
                        const chatbotReply = data.chatbot_reply;

                        // Replace the user's query with the chatbot's reply
                        // - This allows the user to see the query that is being processed rather
                        //   than delaying it until we receive OpenAI's response
                        this.setState((prevState) => ({
                            chatHistory: [
                                ...prevState.chatHistory.slice(0, -2),
                                "USR" + sanitizedUserQuery,
                                "BOT" + chatbotReply,
                            ],
                            query: "",
                            waiting: false,
                        }), () => {
                            // Scroll the chat log container to the bottom
                            this.chatLogRef.current.scrollTop = this.chatLogRef.current.scrollHeight;
                        });
                    }
                    else if (response.status === 429) {
                        // Rate limit exceeded (actually handled by handle_rate_limit_error() in app.py but I'll keep it here in case)
                        this.setState((prevState) => ({
                            chatHistory: [
                                ...prevState.chatHistory.slice(0, -2),
                                "USR" + userQuery,
                                "BOT❌ Notice: You are sending requests too fast! Please wait at least 1 minute before sending your next request. This cooldown is applied to avoid spam abuse of the website.",
                            ],
                            query: "",
                            waiting: false,
                        }), () => {
                            // Scroll the chat log container to the bottom
                            this.chatLogRef.current.scrollTop = this.chatLogRef.current.scrollHeight;
                        });
                    }
                } catch (error) {
                    console.error(error);
                }
            };


            // Update "query" when user types
            handleInputChange = (event) => {
                this.setState({ query: event.target.value });
            };


            // Submit on "enter" button
            handleTextareaKeyDown = (event) => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    this.handleSubmit(event);
                }
            };


            // Render to the DOM
            render() {
                return (
                    <div id="chat-container" className={this.state.about ? "small-width" : ""}>
                        <div className="header">
                            <a href="/" className="logo">
                                <img className="logo" src=".././static/images/quickyelp_logo_white.png" alt="QuickYelp"/>
                            </a>

                            <div className="powered-section">
                                <p className="powered-by">
                                    Powered By:&nbsp;
                                    <a href="https://fusion.yelp.com/"><img className="powered-logos" src=".././static/images/yelp.png" alt="Yelp Fusion"/> </a>
                                    <a href="https://openai.com/blog/openai-api"><img className="powered-logos" src=".././static/images/openai.png" alt="OpenAI"/> </a>
                                    <a href="https://www.langchain.com/"><img className="powered-logos" src=".././static/images/langchain.png" alt="LangChain "/></a>
                                </p>
                                <p className="powered-by">
                                    GitHub:&nbsp;
                                    <a href="https://github.com/julian-z/QuickYelp"><img className="powered-logos" src=".././static/images/sm_github.png" alt="Github Repo"/></a>
                                </p>
                            </div>
                        </div>

                        <div id="chat-log-container" ref={this.chatLogRef}>
                            <div id="chat-log-content">
                                {this.state.chatHistory.map((entry, index) => (
                                    <div key={index} className="message-container">
                                        <div
                                            className={`${
                                                entry.startsWith("USR") ? "user-message" : "chatbot-message"
                                            } ${
                                                entry.startsWith("USR") ? "animate-fade-in-right" : "animate-fade-in-left"
                                            }`}
                                        >
                                            {entry.startsWith("BOT") && "🤖 "}
                                            {entry.substring(3) === "LOADING" && "Thinking... "}
                                            {entry.substring(3) === "LOADING" && (<span className="loading-animation"></span>)}
                                            {entry.substring(3) !== "LOADING" && entry.substring(3)}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="query-bar">
                            <form id="chat-form" onSubmit={this.handleSubmit}>
                                <input
                                    type="text"
                                    name="query"
                                    id="query"
                                    placeholder="Ask a question..."
                                    value={this.state.query}
                                    onChange={this.handleInputChange}
                                    autocomplete="off"
                                    required
                                    disabled={this.state.waiting}
                                />
                                <input type="submit" value="Ask" disabled={this.state.waiting}/>
                            </form>
                        </div>
                    </div>
                );
            }
        }
    
        // Render the ChatApp component
        ReactDOM.render(<ChatApp />, document.getElementById("react-chat"));
    </script>
</body>
</html>

