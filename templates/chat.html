<!DOCTYPE html>
<html>
<head>
    <title>QuickYelp - Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='outputs.css') }}">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="react-chat"></div>
    
    <!-- react-chat -->
    <script type="text/babel">
        // Inherit React component
        class ChatApp extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    chatHistory: [],
                    query: "",
                };
                this.chatLogRef = React.createRef();
            }
    
            // Handle asynchronous calls to Flask
            handleSubmit = async (event) => {
                event.preventDefault();
    
                const formData = new FormData(event.target);
    
                try {
                    const response = await fetch("/", {
                        method: "POST",
                        body: formData,
                    });
    
                    if (response.ok) {
                        const data = await response.json();
                        const chatHistory = data.chat_history;
                        const chatbotReply = data.chatbot_reply;
    
                        this.setState((prevState) => ({
                            chatHistory: [...prevState.chatHistory, "USR" + prevState.query, "BOT" + chatbotReply],
                            query: "",
                        }), () => {
                            // Scroll the chat log container to the bottom
                            this.chatLogRef.current.scrollTop = this.chatLogRef.current.scrollHeight;
                        });
                    }
                } catch (error) {
                    console.error(error);
                }
            };
    

            // Update "query" when user types
            handleInputChange = (event) => {
                this.setState({ query: event.target.value });
            };


            // Submit on "enter" button
            handleTextareaKeyDown = (event) => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    this.handleSubmit(event);
                }
            };


            // Render to the DOM
            render() {
                return (
                    <div id="chat-container">
                        <a href="/" className="logo">
                            <img className="logo" src=".././static/images/quickyelp_logo_white.png" alt="QuickYelp"/>
                        </a>
    
                        <div id="chat-log-container" ref={this.chatLogRef}>
                            <div id="chat-log-content">
                                {this.state.chatHistory.map((entry, index) => (
                                    <div key={index} className={entry.startsWith("USR") ? "user-message" : "chatbot-message"}>
                                        {entry.startsWith("USR") ? "😁 " : "🤖 "} {entry.substring(3)}
                                    </div>
                                ))}
                            </div>
                        </div>
    
                        <form id="chat-form" onSubmit={this.handleSubmit}>
                            <input
                                type="text"
                                name="query"
                                id="query"
                                value={this.state.query}
                                onChange={this.handleInputChange}
                                autocomplete="off"
                                required
                            />
                            <input type="submit" value="Ask" />
                        </form>
                    </div>
                );
            }
        }
    
        // Render the ChatApp component
        ReactDOM.render(<ChatApp />, document.getElementById("react-chat"));
    </script>
</body>
</html>

